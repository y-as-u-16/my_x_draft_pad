name: Flutter Test

on:
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Create dummy .env file
        run: |
          echo "# Dummy env for testing" > .env

      - name: Verify formatting
        id: format
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze project source
        id: analyze
        run: flutter analyze --no-fatal-infos

      - name: Run tests
        id: test
        run: flutter test --coverage

      - name: Calculate coverage
        id: coverage
        if: always()
        run: |
          if [ -f coverage/lcov.info ]; then
            COVERAGE=$(awk -F ':' 'BEGIN {hit=0; found=0} /^LH:/ {hit+=$2} /^LF:/ {found+=$2} END {if(found>0) printf "%.1f", hit/found*100; else print "0"}' coverage/lcov.info)
            echo "percentage=${COVERAGE}" >> $GITHUB_OUTPUT
          else
            echo "percentage=N/A" >> $GITHUB_OUTPUT
          fi

      - name: PRにコメント
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const formatStatus = '${{ steps.format.outcome }}';
            const analyzeStatus = '${{ steps.analyze.outcome }}';
            const testStatus = '${{ steps.test.outcome }}';
            const coverage = '${{ steps.coverage.outputs.percentage }}';

            const icon = (s) => s === 'success' ? '✅' : '❌';
            const allPassed = formatStatus === 'success' && analyzeStatus === 'success' && testStatus === 'success';

            const body = `### ${allPassed ? '✅' : '❌'} Flutter テスト結果

            | チェック項目 | 結果 |
            |-------------|------|
            | ${icon(formatStatus)} フォーマット | ${formatStatus} |
            | ${icon(analyzeStatus)} 静的解析 | ${analyzeStatus} |
            | ${icon(testStatus)} テスト | ${testStatus} |

            **カバレッジ: ${coverage}%**
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Flutter テスト結果')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
